---
title: "Riskgroup2_grouped"
author: "Elisa Rubio"
date: "2022-11-13"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(cache=FALSE,
                      echo=TRUE, warning=FALSE, message=FALSE, results ='markup')
options(warn=-1)
```

```{r message=FALSE}
library(tidyverse)
library(kableExtra)
library(vegan)
library(ggpubr)
library(glue)
library(patchwork)
library(ggstatsplot)
library(broom)
library(ggthemes)
library(ggrepel)
```

#### Load data and functions

```{r}
load("output/summarized_ariba.RDA")
load("output/ariba_dist.RDA")
load("output/grouped_rpkm_ariba.RDA")
load("output/grouped_refname_ariba.RDA")
metadata<-read_csv("data/Metadata/metadata.csv")
source("code/functions_paper.R")
```

## Load metadata

```{r}
metadata<-read_csv("data/Metadata/metadata.csv")%>%
  mutate(MSM_dic=ifelse(RiskGroup2=="msm", "MSM", "no MSM"),
         CD4_CD8_ratio=CD4/CD8_absolute,
         Cluster=factor(Cluster, levels = c("Prevotella", "Bacteroides")))

gene_richness<-read.delim2("data/Metadata/generichness_data.txt")%>%
  select(SampleID, GCount)
metadata<-metadata%>%
  inner_join(gene_richness, by="SampleID")
```

## Relative Abundances
```{r}
rel_abund_refname<-ariba_rpkm%>%pivot_longer(-ref_name, names_to = "Sample", values_to = "RPKM")%>%
  group_by(ref_name)%>%
  summarize(count=sum(RPKM))%>%
  ungroup()%>%
  mutate(rel_abund=count*100/sum(count))%>%
  arrange(desc(count))

abund_genefamily<-ariba_rpkm_genefamily%>%
  pivot_longer(-`AMR Gene Family`, names_to = "Sample", values_to = "RPKM")%>%
  group_by(`AMR Gene Family`)%>%
  summarize(count=sum(RPKM))%>%
  ungroup()%>%
  arrange(desc(count))
  
 colors<-c("darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1",
            "lightskyblue", "darkgreen", "deeppink", "khaki2", "firebrick", "brown1",
            "darkorange1", "cyan1", "royalblue4", "darksalmon", "chartreuse1","darkorchid4",
            "gold","forestgreen", "lightpink","green", "red","darkgrey","blue","aquamarine", "burlywood1",
            "darkslateblue", "chartreuse3","firebrick3", "aquamarine4","azure1","chocolate1","deeppink4","aquamarine2", "burlywood1",
            "darkblue", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1",
            "lightskyblue", "darkgreen", "darkseagreen3", "khaki2", "firebrick", "brown1", "darkslateblue")

abund_genefamily%>%
  slice(1:20)%>%
  mutate(rel_abund=count*100/sum(count))%>%
  mutate(x="Overall")%>%
  ggplot(aes(x=x, y=rel_abund, fill=`AMR Gene Family`))+
  geom_bar(aes(), stat="identity", position="stack") +
  scale_fill_manual(values =colors) +
  theme(legend.position="bottom",
          axis.text.y.left = element_blank(),
          axis.text.x = element_text(size = 10),
          axis.title.y = element_text(size = 10),
          axis.ticks.y=element_blank(),
          strip.text.x = element_text(face = "bold"),
          title = element_text(size = 10) ) + guides(fill=guide_legend(nrow=5))
  

```


### Alpha diversity analysis 

```{r}
ariba_alpha_rpkm<-alpha_div(ariba_rpkm, ariba_counts, metadata)

##alpha_div_plot_all(ariba_alpha_rpkm, MSM_dic)
```

#### Figure 1

```{r}

p1<-ariba_alpha_rpkm%>%
    ##filter(!is.na(!!clin_var))%>%
  rename(`Inverse Simpson` = InvSimpson)%>%
    pivot_longer(cols=c(Shannon, `Inverse Simpson`), names_to = "Alpha_Index", values_to = "Alpha_value")%>%
    mutate(Alpha_Index=factor(Alpha_Index, levels = c("Shannon", "Inverse Simpson")))%>%
    ggplot(aes(x=MSM_dic, y=Alpha_value))+
    geom_boxplot(aes(colour=MSM_dic))+
    geom_jitter(width = 0.2, aes(colour=MSM_dic))+
    facet_wrap(vars(Alpha_Index), ncol = 1, scales = "free_y")+
    stat_compare_means(label="p.format", label.x = 1.5, label.y.npc = 0.9)+
    scale_color_manual(values = c("red", "gray48"))+
    scale_fill_manual(values = c("pink", "gray80"))+
    theme_bw()+
    labs(title = "Sexual preference", y="Alpha diversity")+
    theme(legend.position = "none", axis.title.x=element_blank(),
          axis.text.x = element_text(angle=45, hjust = 1))


p2<-ariba_alpha_rpkm%>%
  rename(`Inverse Simpson` = InvSimpson)%>%
    ##filter(!is.na(!!clin_var))%>%
    pivot_longer(cols=c(Shannon, `Inverse Simpson`), names_to = "Alpha_Index", values_to = "Alpha_value")%>%
    mutate(Alpha_Index=factor(Alpha_Index, levels = c("Shannon", "Inverse Simpson")))%>%
    ggplot(aes(x=GCount, y=Alpha_value))+
    geom_boxplot(aes(colour=GCount))+
    geom_jitter(width = 0.2, aes(colour=GCount))+
    facet_wrap(vars(Alpha_Index), ncol = 1, scales = "free_y")+
    stat_compare_means(label="p.format", label.x = 1.5, label.y.npc = 0.9)+
    scale_color_manual(values = c("red", "gray48"))+
    scale_fill_manual(values = c("pink", "gray80"))+
    theme_bw()+
    labs(title = "Gene richness", y=NULL, caption = "P values calculated by Wilcoxon test")+
    theme(legend.position = "none", axis.title.x=element_blank(),
          axis.text.x = element_text(angle=45, hjust = 1))

figure1<-p1+p2
figure1 + plot_annotation(tag_levels = 'A')


ggsave("output/Paper/figure1.tiff", height = 6, width = 6)

```

#### Supplementary figure 1

```{r}
sfigure1<-ariba_alpha_rpkm%>%
  rename(`Inverse Simpson` = InvSimpson)%>%
    ##filter(!is.na(Cluster))%>%
    pivot_longer(cols=c(Shannon, `Inverse Simpson`), names_to = "Alpha_Index", values_to = "Alpha_value")%>%
    ggplot(aes(x=Cluster, y=Alpha_value))+
    geom_boxplot(aes(colour=Cluster))+
    geom_jitter(width = 0.2, aes(colour=Cluster))+
    facet_wrap(vars(Alpha_Index), ncol = 2, scales = "free_y")+
    stat_compare_means(label="p.format", label.x = 1.5, label.y.npc = 0.9)+
    scale_color_manual(values = c("red", "gray48"))+
    scale_fill_manual(values = c("pink", "gray80"))+
    theme_bw()+
    labs(title = "Microbiome cluster", y="Alpha diversity", caption = "P values calculated by Wilcoxon test")+
    theme(legend.position = "none", axis.title.x=element_blank(),
          axis.text.x = element_text(angle=45, hjust = 1))

sfigure1
ggsave("output/Paper/sfigure1.tiff", height = 3, width = 6)
```



### Beta diversity analysis 

```{r}
ariba_dist_rpkm<-ariba_dist$dist_rpkm
```

#### Figure 2
Resistome composition is different according to MSM

```{r}
##ECCMID figure
  dist_df<-as.data.frame(as.matrix(ariba_dist_rpkm)); dist_df$SampleID<-rownames(dist_df)
  meta_dist<-inner_join(metadata, dist_df, by="SampleID")
    ##filter(!is.na(Cluster))

  dist<-meta_dist%>%
    select(all_of(.[["SampleID"]]))%>%
    as.dist()

  msm_dic<-meta_dist%>%pull(MSM_dic) ##clin_var vector for adonis test
  test_msm<-adonis(dist~msm_dic, permutations = 999)
  ptest_msm<-test_msm$aov.tab$`Pr(>F)`[1]
  r2test_msm<-round(test_msm$aov.tab$R2[1],2)
  
  GCount<-meta_dist%>%pull(GCount) ##clin_var vector for adonis test
  test_Gcount<-adonis(dist~GCount, permutations = 999)
  ptest_GCount<-test_Gcount$aov.tab$`Pr(>F)`[1]
  r2test_GCount<-round(test_Gcount$aov.tab$R2[1],2)
  
  Cluster<-meta_dist%>%pull(Cluster) ##clin_var vector for adonis test
  test_Cluster<-adonis(dist~Cluster, permutations = 999)
  ptest_Cluster<-test_Cluster$aov.tab$`Pr(>F)`[1]
  r2test_Cluster<-round(test_Cluster$aov.tab$R2[1],2)
  

  set.seed(200889)
  nmds <- metaMDS(dist, trace = 0, trymax = 200)

  ##scores(nmds) %>%
p1<-nmds$points %>%
    as_tibble(rownames = "SampleID") %>%
    rename(NMDS1=MDS1, NMDS2=MDS2) %>%
    inner_join(., metadata, by="SampleID") %>%
    ##filter(!is.na(MSM_dic))%>%
    ggplot(aes(x=NMDS1, y=NMDS2, color=MSM_dic, fill=MSM_dic)) +
    stat_ellipse(geom="polygon", show.legend = FALSE, alpha=0.2)+
    geom_point()+
    coord_fixed(ratio = 0.8)+
    annotate("text", x = -0.35, y = 0.22, label = glue("ADONIS p={ptest_msm} \n r²={r2test_msm}"), size=4, hjust=0)+
    scale_color_manual(name="Sexual \nPreference",
                      values = c("red", "gray48"))+
    scale_fill_manual(name="Sexual \nPreference", 
                      values = c("pink", "gray80"))+
    theme_bw()+
    theme(text = element_text(size=15))
  
  
p2<-nmds$points %>%
    as_tibble(rownames = "SampleID") %>%
    rename(NMDS1=MDS1, NMDS2=MDS2) %>%
    inner_join(., metadata, by="SampleID") %>%
    ##filter(!is.na(MSM_dic))%>%
    ggplot(aes(x=NMDS1, y=NMDS2, color=GCount, fill=GCount)) +
    stat_ellipse(geom="polygon", show.legend = FALSE, alpha=0.2)+
    geom_point()+
    coord_fixed(ratio = 0.8)+
    annotate("text", x = -0.35, y = 0.22, label = glue("ADONIS p={ptest_GCount} \n r²={r2test_GCount}"), size=4, hjust=0)+
    scale_color_manual(name="Gene \nRichness",
                      values = c("red", "gray48"))+
    scale_fill_manual(name="Gene \nRichness", 
                      values = c("pink", "gray80"))+
    theme_bw()+
    theme(text = element_text(size=15))
  

figure2<-p1/p2
figure2 + plot_annotation(tag_levels = 'A') 
  
ggsave("output/Paper/figure2.tiff", height = 8, width = 6)
```


#### Supplementary figure 2 (missing value!)

```{r}

sfigure2<-nmds$points %>%
    as_tibble(rownames = "SampleID") %>%
    rename(NMDS1=MDS1, NMDS2=MDS2) %>%
    inner_join(., metadata, by="SampleID") %>%
    ##filter(!is.na(MSM_dic))%>%
    ggplot(aes(x=NMDS1, y=NMDS2, color=Cluster, fill=Cluster)) +
    stat_ellipse(geom="polygon", show.legend = FALSE, alpha=0.2)+
    geom_point()+
    coord_fixed(ratio = 0.8)+
    annotate("text", x = -0.35, y = 0.22, label = glue("ADONIS p={ptest_Cluster} \n r²={r2test_Cluster}"), size=4, hjust=0)+
    scale_color_manual(name="Microbiome \nCluster",
                      values = c("red", "gray48"))+
    scale_fill_manual(name="Microbiome \nCluster", 
                      values = c("pink", "gray80"))+
    theme_bw()+
    theme(text = element_text(size=15))

sfigure2
ggsave("output/Paper/sfigure2.tiff", height = 4, width = 6)
```



## Biplot

## Gene family correlations with NMDS axes

### Figure 3

```{r}
set.seed(200889)
cor_rpkm_genefamily<-corr_group_envfit(data_group=ariba_rpkm_genefamily, refdata_group = refname_ariba_genefamily, nmds = nmds)

cor_level<-0.2
cor_rpkm_genefamily_corlev2<-cor_rpkm_genefamily%>%filter(p.value<=0.05 & r2 > cor_level)

writexl::write_xlsx(cor_rpkm_genefamily_corlev2, "output/Paper/biplot_correlations.xlsx")

```


```{r}
cor_rpkm_genefamily_corlev<-cor_rpkm_genefamily_corlev2%>%
   mutate(group_name = replace(group_name, group_name == "23S rRNA with mutation conferring resistance to macrolide antibiotics", "23S rRNA with mutation \n conferring resistance to \n macrolide antibiotics"),
          group_name = replace(group_name, group_name=="Erm 23S ribosomal RNA methyltransferase", "Erm 23S ribosomal \nRNA methyltransferase" ),
          group_name = replace(group_name, group_name=="ABC-F ATP-binding cassette ribosomal protection protein", "ABC-F ATP-binding cassette \nribosomal protection protein"))
```

```{r}
figure3<-biplot_amr_envfit(cor_rpkm_genefamily_corlev, nmds, metadata, MSM_dic, group_name)+
    scale_color_manual(name="Sexual \nPreference",
                      values = c("red", "gray48"))+
    scale_fill_manual(name="Sexual \nPreference", 
                      values = c("pink", "gray80"))+
  labs(caption = "Gene family significant correlations (p<0.05) with r²>0.2")

figure3

ggsave("output/Paper/figure3.tiff", height = 6, width = 8)
```


```{r}
p1<-biplot_amr_envfit(cor_rpkm_genefamily_corlev, nmds, metadata, GCount, group_name)+
    scale_color_manual(name="Gene \nRichness",
                      values = c("red", "gray48"))+
    scale_fill_manual(name="Gene \nRichness", 
                      values = c("pink", "gray80"))

p2<-biplot_amr_envfit(cor_rpkm_genefamily_corlev, nmds, metadata, Cluster, group_name)+
    scale_color_manual(name="Microbiome \nCluster",
                      values = c("red", "gray48"))+
    scale_fill_manual(name="Microbiome \nCluster", 
                      values = c("pink", "gray80"))+
  labs(caption = "Gene family significant correlations (p<0.05) with r²>0.2")

sfigure3<-p1/p2
sfigure3 + plot_annotation(tag_levels = 'A') 

ggsave("output/Paper/sfigure3.tiff", height = 12, width = 8)

```


## Check differentially abundance AMR

```{r}
amr_sig_rpkm_MSM_dic<-sig_AMR_clin_dic(ariba_rpkm, metadata, refname_all_ariba, MSM_dic)
amr_sig_rpkm_MSM_dic$sig_data%>% kable(caption="** Significant AMR accordig to Sexual preference (Ariba RPKM) **")%>%kable_paper("striped")%>%scroll_box(width = "100%", height = "500px")

##writexl::write_xlsx(amr_sig_rpkm_MSM_dic$sig_data, "output/Paper/amr_sexualpreference.xlsx")
```


## Check differentially abundance (grouped by Drug Class)


```{r}
drugclass_sig_rpkm_MSM_dic<-sig_group_clin_dic(ariba_rpkm_drugclass, metadata, refname_ariba_drugclass, MSM_dic)
drugclass_sig_rpkm_MSM_dic$sig_data%>% kable(caption="**Significant Drug Classes, MSM (Ariba RPKM)**")%>%kable_paper("striped")%>%scroll_box(width = "100%", height = "500px")

drugclass<-drugclass_sig_rpkm_MSM_dic$sig_data
##writexl::write_xlsx(drugclass, "output/Paper/drugclass_sexualpreference.xlsx")
```


## Check differentially abundance (grouped by Gene Family)

```{r}
genefamily_sexualp<-sig_group_clin_dic(ariba_rpkm_genefamily, metadata, refname_ariba_genefamily, MSM_dic)
genefamily_gcount<-sig_group_clin_dic(ariba_rpkm_genefamily, metadata, refname_ariba_genefamily, GCount)
genefamily_cluster<-sig_group_clin_dic(ariba_rpkm_genefamily, metadata, refname_ariba_genefamily, Cluster)

genefamily_sexualp$sig_data<-genefamily_sexualp$sig_data%>%rename(p.adjust_sexualp=p.adjust, log2f_sexualp=log2f)
genefamily_gcount$sig_data<-genefamily_gcount$sig_data%>%rename(p.adjust_gcount=p.adjust, log2f_gcount=log2f)

genefamily_cluster$sig_data<-genefamily_cluster$sig_data%>%rename(p.adjust_cluster=p.adjust, log2f_cluster=log2f)

table3_genefamily<-full_join(genefamily_sexualp$sig_data,genefamily_gcount$sig_data)
##writexl::write_xlsx(table3_genefamily, "output/Paper/table3_genefamily.xlsx")

##writexl::write_xlsx(genefamily_cluster$sig_data, "output/Paper/stable_genefamily.xlsx")
```

```{r}
tableX_genefamily<-full_join(genefamily_sexualp$sig_data,genefamily_cluster$sig_data)
```



```{r}
genefamily_sexualp$sig_data%>%
  kable()%>%kable_paper("striped")%>%scroll_box(width = "100%", height = "500px")

##writexl::write_xlsx(genefamily_sexualp$sig_data, "output/Paper/genefamily_sexualpreference.xlsx")
```











